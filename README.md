# Delta Pack

A TypeScript library for efficient binary serialization with delta compression support. Define schemas, encode/decode data, and efficiently transmit only changed values.

## Features

- **Strong TypeScript type safety:** Define well-typed schemas
- **Efficient binary encoding/decoding:** Convert data to a compact binary format (Uint8Array)
- **Delta compression:** Transmit only the differences between states
- **Schema validation:** Built-in methods to validate data
- **Composable schemas:** Combine primitives, objects, and arrays seamlessly

## Installation

Install the library via npm:

```bash
npm install delta-pack
```


## Getting Started

Delta Pack uses schema definitions to generate encoding, decoding, diffing, and validation functions. Below is an example showing how to define a schema and use delta compression.

### Defining a Schema

Use the provided constructors to build your schemas:

```ts
import {
  ObjectType,
  ReferenceType,
  ChildType,
  Modifier,
  BooleanType,
  FloatType,
  IntType,
  StringType
} from 'delta-pack'

// Define a Position schema
const Position = ObjectType({
  x: FloatType(),
  y: FloatType()
})

// Define a Weapon schema
const Weapon = ObjectType({
  name: StringType(),
  damage: IntType()
})

// Define a Player schema that references the Position and Weapon schemas
const Player = ObjectType({
  id: IntType(),
  position: ReferenceType('Position'),
  health: IntType(),
  weapon: ChildType(ReferenceType('Weapon'), Modifier.OPTIONAL),
  stealth: BooleanType()
})

// Define a GameState schema that holds an array of Players
const GameState = ObjectType({
  timeRemaining: IntType(),
  players: ChildType(ReferenceType('Player'), Modifier.ARRAY)
})
```

### Serializing and Deserializing

Create a default state and encode it into a binary format:

```ts
// Create a state object.
const state = {
  timeRemaining: 120,
  players: [
    {
      id: 1,
      position: { x: 94.5, y: 102.3 },
      health: 100,
      weapon: { name: 'Sword', damage: 10 },
      stealth: false
    },
    {
      id: 2,
      position: { x: 216.6, y: 198.1 },
      health: 100,
      weapon: { name: 'Bow', damage: 5 },
      stealth: true
    }
  ]
}

// Serialize the state to a binary representation.
const binaryState = GameState.encode(state)

// Deserialize the binary back into a state object.
const decodedState = GameState.decode(binaryState)
```

### Delta Compression

When only some fields change between states, you can compute a diff to only transmit those changes:

```ts
// Previous state.
const state1 = {
  timeRemaining: 114,
  players: [
  {
    id: 1,
    position: { x: 94.5, y: 102.3 },
    health: 100,
    weapon: { name: 'Sword', damage: 25 },
    stealth: false
  },
  {
    id: 2,
    position: { x: 216.6, y: 198.1 },
    health: 100,
    weapon: { name: 'Bow', damage: 15 },
    stealth: true
  }
  ]
}

// New state with some changes.
const state2 = {
  id: 1,
  players: [
  {
    id: 1,
    position: { x: 106.5, y: 114.3 },
    health: 85,
    weapon: { name: 'Sword', damage: 25 },
    stealth: false
  },
  {
    id: 2,
    position: { x: 216.6, y: 198.1 },
    health: 100,
    weapon: { name: 'Bow', damage: 15 },
    stealth: true
  }
  ]
}

// Compute the diff between state2 and state1.
const delta = GameState.encode(state2, state1)

// Merge the delta with the previous state to obtain the updated state.
const updatedState = GameState.decode(delta, state1)
```


Internally, Delta Pack uses a special symbol (`NO_DIFF`) to mark properties that have not changed. This ensures that only the necessary modifications are transmitted.


## API Reference

Each schema generated by Delta Pack includes the following methods:

- **encode(state: T, prevState?: T): Uint8Array**  
  Encodes a state into a binary `Uint8Array`. The previous state may be provided to produce a state delta.

- **decode(binary: Uint8Array | ArrayBuffer, prevState?: T): T**  
  Decodes a binary `Uint8Array` or `ArrayBuffer` into a value of type `T`. If the binary data represents a delta update, the previous state may be provided to merge a state delta.

## Testing

Delta Pack comes with a comprehensive test suite powered by Jest. To run the tests, use:

```bash
npm test
```

## Conclusion

Delta Pack provides a type-safe and efficient approach to binary serialization and delta compression. Its high-level API abstracts away complex low-level details, making it ideal for real-time applications such as games and data synchronization.

For more detailed examples, refer to the test files in the `src/tests` directory.

Happy coding! ðŸš€
